#!/bin/sh

WPA_CONF="/etc/wpa_supplicant.conf"
IFACE="wlan0"

wait_iface() {
  for i in $(seq 1 20); do
    [ -d "/sys/class/net/$IFACE" ] && return 0
    sleep 0.5
  done
  echo "[$0] $IFACE not found; abort" >&2
  return 1
}

case "$1" in
  start)
    wait_iface || exit 1

    echo "Starting WiFi on $IFACE"
    iw dev "$IFACE" set power_save off
    iw reg set JP
    wpa_supplicant -B -i "$IFACE" -c "$WPA_CONF" -D nl80211
    ;;
  stop)
    echo "Stopping WiFi on $IFACE"
    killall wpa_supplicant 2>/dev/null
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
esac

exit 0
